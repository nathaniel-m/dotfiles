#!/usr/bin/env bash

# Minimal macOS System Preferences
# Only the most useful settings for developers

echo "Configuring macOS settings..."

# Ask for administrator password upfront
sudo -v

# Keep-alive: update existing sudo time stamp
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

###############################################################################
# Safari
###############################################################################

# Show Safari's bookmark bar.
defaults write com.apple.Safari.plist ShowFavoritesBar -bool true

# Set up Safari for development.
defaults write com.apple.Safari.SandboxBroker ShowDevelopMenu -bool true
defaults write com.apple.Safari.plist IncludeDevelopMenu -bool true
defaults write com.apple.Safari.plist WebKitDeveloperExtrasEnabledPreferenceKey -bool true
defaults write com.apple.Safari.plist "com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled" -bool true
defaults write NSGlobalDomain WebKitDeveloperExtras -bool true

###############################################################################
# Finder
###############################################################################

echo "→ Configuring Finder..."

# Show all filename extensions
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Show path bar
defaults write com.apple.finder ShowPathbar -bool true

# Show status bar
defaults write com.apple.finder ShowStatusBar -bool true

# Avoid creating .DS_Store files on network or USB volumes
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# Keep folders on top when sorting by name
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# When performing a search, search the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# Use list view in all Finder windows by default
# Four-letter codes for the other view modes: `icnv`, `clmv`, `glyv`
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# Show the ~/Library folder
chflags nohidden ~/Library

###############################################################################
# Dock
###############################################################################

echo "→ Configuring Dock..."

# Automatically hide and show the Dock
defaults write com.apple.dock autohide -bool true

# Don't show recent applications in Dock
defaults write com.apple.dock show-recents -bool false

# Configure Dock with only essential apps
if command -v dockutil &> /dev/null; then
    echo "→ Configuring Dock apps..."

    # Remove all apps except Finder (Finder can't be removed)
    dockutil --remove all --no-restart 2>/dev/null

    # Add only the apps we want (in order)
    dockutil --add "/System/Applications/Utilities/Terminal.app" --no-restart
    dockutil --add "/Applications/Google Chrome.app" --no-restart
    dockutil --add "/System/Applications/Safari.app" --no-restart
    dockutil --add "/System/Applications/Utilities/Screenshot.app" --no-restart
    dockutil --add "/Applications/Visual Studio Code.app" --no-restart
    dockutil --add "/Applications/Notion.app" --no-restart

    echo "✓ Dock configured"
else
    echo "⊘ dockutil not installed - skipping Dock configuration"
fi

###############################################################################
# Keyboard & Trackpad
###############################################################################

echo "→ Configuring keyboard and trackpad..."

# Enable tap to click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Fast keyboard repeat rate
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 15

# Disable auto-correct
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

###############################################################################
# Screenshots
###############################################################################

echo "→ Configuring screenshots..."

# Save screenshots to Desktop
defaults write com.apple.screencapture location -string "${HOME}/Desktop"

# Save screenshots in PNG format
defaults write com.apple.screencapture type -string "png"

###############################################################################
# General UI/UX                                                               
###############################################################################

# Disable automatic capitalization as it’s annoying when typing code
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false

# Disable smart dashes as they’re annoying when typing code
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

# Disable automatic period substitution as it’s annoying when typing code
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false

# Disable smart quotes as they’re annoying when typing code
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

# Don’t automatically rearrange Spaces based on most recent use
defaults write com.apple.dock mru-spaces -bool false

###############################################################################
# Restart affected apps
###############################################################################

echo "→ Restarting affected applications..."

for app in "Dock" "Finder"; do
	killall "${app}" &> /dev/null
done

echo "✓ Done! Some changes may require a logout/restart to take full effect."
